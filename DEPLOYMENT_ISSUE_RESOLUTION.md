# Deployment Issue Resolution: CloudFormation Export Dependency

## Root Cause Analysis

### Problem
The `shared-infra-stack` deployment failed with error:
```
Cannot delete export shared-infra-stack:ExportsOutputFnGetAttappsiteappsiteBucketDC62C27CArnE1840A48 
as it is in use by core-appplane-stack.
```

### Technical Explanation

1. **CloudFormation Export Dependency Chain:**
   - `shared-infra-stack` creates S3 bucket exports (auto-generated by CDK when passing resources between stacks)
   - `core-appplane-stack` imports these exports via CodePipeline resources that deploy to the bucket
   - CloudFormation **prevents deleting exports** that are still imported by other stacks

2. **Deployment Order Issue:**
   - We attempted to deploy `shared-infra-stack` FIRST to remove the exports
   - But `core-appplane-stack` still had active resources (CodePipeline, CodeBuild) importing those exports
   - CloudFormation blocked the export deletion, causing rollback

3. **Stack State:**
   - `shared-infra-stack` is now in `UPDATE_ROLLBACK_COMPLETE` state
   - This is safe - the rollback has completed
   - We can proceed with the correct deployment order

## Solution

### Correct Deployment Order

**Phase 1: Deploy `core-appplane-stack` FIRST**
- Removes CodePipeline, CodeBuild, and S3 resources that import the bucket exports
- This removes the imports, allowing exports to be deleted later

**Phase 2: Deploy `shared-infra-stack` SECOND**
- Now safe to remove the bucket exports
- Adds `NextJsAppUrl` output

**Phase 3: Deploy `tenant-template-stack-basic`**
- Updates email templates to use NextJS URL

### Updated Deployment Script

The `deploy-incremental.sh` script has been updated with:

1. **New command: `check-rollback-state`**
   - Checks if stacks are in rollback state
   - Validates readiness for deployment

2. **Reordered deployment functions:**
   - `deploy-core-appplane` is now Phase 1 (must be first)
   - `deploy-shared-infra` is now Phase 2 (must be after core-appplane)
   - Added validation to prevent wrong order

3. **Safety checks:**
   - `deploy-shared-infra` now checks if `core-appplane-stack` still has resources using exports
   - Prevents deployment if dependencies still exist

## Deployment Steps

### Step 1: Check Rollback State
```bash
cd /Users/shoaibrain/edforge/scripts
AWS_PROFILE=dev ./deploy-incremental.sh check-rollback-state
```

Expected output: Stack is in `UPDATE_ROLLBACK_COMPLETE` (safe to proceed)

### Step 2: Deploy core-appplane-stack FIRST
```bash
AWS_PROFILE=dev ./deploy-incremental.sh deploy-core-appplane
```

This will:
- Remove CodePipeline resources
- Remove CodeBuild project
- Remove S3 bucket for Application client
- Remove all IAM roles/policies related to Application client
- Remove imports of bucket exports

### Step 3: Deploy shared-infra-stack SECOND
```bash
AWS_PROFILE=dev ./deploy-incremental.sh deploy-shared-infra
```

This will:
- Remove old bucket exports (now safe since imports are gone)
- Add `NextJsAppUrl` output

### Step 4: Deploy tenant-template-stack-basic
```bash
AWS_PROFILE=dev ./deploy-incremental.sh deploy-tenant-basic
```

This will:
- Update Cognito UserPool email templates
- Use NextJS URL instead of CloudFront URL

## Validation

After each deployment, the script automatically validates:
- ✅ Resources removed successfully
- ✅ Outputs created correctly
- ✅ Email templates updated

## Why This Order Matters

CloudFormation export/import dependencies are **strict**:
- You cannot delete an export if it's imported by another stack
- You must remove the imports first (by deleting resources that use them)
- Then you can safely delete the exports

This is a fundamental CloudFormation constraint to prevent breaking cross-stack references.

## Prevention

The updated script includes:
1. **Order validation** - Prevents deploying shared-infra before core-appplane
2. **Resource checks** - Verifies no conflicting resources exist
3. **Clear warnings** - Explains why order matters
4. **Rollback state checking** - Validates stack readiness

## Summary

✅ **Root Cause:** Wrong deployment order - tried to delete exports before removing imports  
✅ **Solution:** Deploy core-appplane-stack first, then shared-infra-stack  
✅ **Status:** Script updated, ready for correct deployment order  
✅ **Risk:** Low - rollback completed, stacks are stable

